# Item 02. 생성자에 매개변수가 많다면 빌더를 고려하라

정적 팩터리와 생성자에는 똑같은 제약이 하나 있다. 선택적 매개변수가 많을 때 적절히 대응하기 어렵다는 점이다.

## 점층적 생성자 패턴

필수 매개변수만 받는 생성자와 추가로 선택 매개변수를 1개부터 n개까지 받는 생성자를 만드는 방식이다.

점층적 생성자 패턴도 쓸 수 있지만, 매개변수 개수가 많아지면 클라이언트 코드를 작성하거나 읽기 어렵다.

매개변수가 많아지면 각 값이 무엇인지 헷갈리며, 개수도 주의해야 하고, 순서를 바꿔 써도 컴파일러가 알아차리지 못하고 런타임에 엉뚱한 동작을 하게 될 수 있다.

## 자바 빈즈 패턴

매개 변수가 없는 생성자로 객체를 만든 후, 세터 메서드를 호출하여 원하는 매개변수의 값을 설정하는 방식이다.

다만 심각한 단점이 있다. 객체 하나를 만들 때 메서드를 여러 개 호출해야 하고, 객체가 생성되고 완전히 세팅되기 전까지는 일관성이 무너진 상태에 놓이게 된다.

점층적 생성자 패턴에서는 생성자에서 매개변수의 유효성을 확인하여 일관성을 유지할 수 있었는데, 그 장치가 사라지고 일관성이 깨진 객체가 만들어질 수 있다.

이런 문제 때문에 자바빈즈 패턴에서는 클래스를 불변으로 만들 수 없으며, 스레드 안전성을 얻으려면 프로그래머가 추가 작업을 해줘야만 한다.

단점을 완화하고자 생성한 객체를 수동으로 얼리고, 얼리기 전에는 사용할 수 없도록 하기도 한다. 하지만 이 방법은 다루기 어려워 실전에서 거의 쓰이지 않고, 프로그래머가 freeze 메서드를 확실히 호출해줬는지를 컴파일러가 보증할 방법이 없어 런타임 오류에 취약하다.

## 빌더 패턴

점층적 생성자 패턴의 안정성과, 자바 빈즈 패턴의 가독성을 겸비한 패턴이다.

필수 매개변수만으로 생성자를 호출하여 빌더 객체를 얻은 후, 빌더 객체가 제공하는 일종의 세터 메서드들로 원하는 선택 매개변수들을 설정한다.

마지막으로 매개변수가 없는 build 메서드를 호출해 우리에게 필요한 객체를 얻는다. 빌더는 생성할 클래스 안에 정적 멤버 클래스로 만들어두는 게 보통이다.

빌더의 세터 메서드들은 빌더 자신을 반환하기 때문에 연쇄적으로 호출할 수 있고, 이런 방식을 메서드 호출이 흐르듯 연결된다는 뜻으로 플루언트 API 혹은 메서드 체이닝이라고 한다.

빌더 패턴의 클라이언트 코드는 쓰기도, 읽기도 쉽다. 매개변수 유효성 검사는 빌더의 생성자와 메서드에서 검사하면 된다. 마지막으로 build 메서드가 호출하는 생성자에서 여러 매개변수에 걸친 검사를 할 수 있다. 이때, 공격에 대비하여 방어적 복사가 필요하다.

**빌더 패턴은 계층적으로 설계된 클래스와 함께 쓰기 좋다.**

각 계층의 클래스에 관련 빌더를 멤버로 정의하자. 추상 클래스는 추상 빌더를, 구체 클래스는 구체 빌더를 갖게 한다.

빌더를 이용하면 가변인수 매개변수를 여러 개 사용할 수 있다. 각각을 적절한 메서드로 나눠 선언하면 된다. 아니면 메서드를 여러 번 호출하도록 하고 각 호출 때 넘겨진 매개변수들을 하나의 필드로 모을 수도 있다. Pizza 클래스의 addTopping 메서드가 그렇게 구현한 예다.

빌더 패턴은 상당히 유연하다. 빌더 하나로 여러 객체를 순회하면서 만들 수 있고, 빌더에 넘기는 매개변수에 따라 다른 객체를 만들 수도 있다. 객체마다 부여되는 일련번호와 같은 특정 필드는 빌더가 알아서 채우도록 할 수도 있다.

빌더 패턴에 장점만 있는 것은 아니다. 객체를 만들려면, 그에 앞서 빌더부터 만들어야 한다. 빌더 생성 비용이 크지는 않지만 성능에 민감한 상황에서는 문제가 될 수 있다. 또한 점층적 생성자 패턴보다는 코드가 장황해서 매개변수가 4개 이상은 되어야 값어치를 한다. 하지만 API는 시간이 지날수록 매개변수가 많아지는 경향이 있음을 명심하자. 애초에 빌더로 시작하는 편이 나을 때가 많다.
